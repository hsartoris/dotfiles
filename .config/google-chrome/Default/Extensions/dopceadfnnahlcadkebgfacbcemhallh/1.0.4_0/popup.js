function parseMagnet(a){for(var b=a.split("magnet:?")[1].split("&"),c={},d=0;d<b.length;d++){var e=b[d].substring(0,2),f=b[d].substring(3);c.hasOwnProperty(e)?("string"==typeof c[e]&&(c[e]=[c[e]]),c[e].push(f)):c[e]=f}if(!c.hasOwnProperty("xt"))return null;var g=c.xt.split(":");c.fh=g[g.length-1],c.dn=cleanName(c.dn);var h="magnet:?xt="+c.xt;for(var i in c)if("xt"!=i)if("string"==typeof c[i])h+="&"+i+"="+encodeURIComponent(c[i]);else for(var d=0;d<c[i].length;d++)h+="&"+i+"="+encodeURIComponent(c[i][d]);return c.href=h,c}function parseTorrent(a){var b={},c=a.substring(0,a.length-8);c=c.search("=")!=-1?c.split("=")[c.split("=").length-1]:c.split("/")[c.split("/").length-1],b.fh=getRandHex(27)+"-UNKNOWN-NAME";var d=c.match(/[A-Fa-f]/g),e=c.match(/[0-9]/g),f=[];return null!==d&&null!==e&&(f=d.concat(e)),40==f.length?b.dn=b.fh:b.dn=cleanName(c),b.href=a,b}function combineMT(a,b){var c={};if(a.length==b.length)for(var d=0;d<a.length;d++){if(a.hasOwnProperty("dn")){a[d].dn}else{b[d].dn}c[a[d].fh]={dn:a[d].dn,mhref:a[d].href,thref:b[d].href}}else{c.magnets={};for(var d=0;d<a.length;d++){if(a.hasOwnProperty("dn")){a[d].dn}else{a[d].fh}c.magnets[a[d].fh]={dn:a[d].dn,href:a[d].href}}c.torrents={};for(var d=0;d<b.length;d++){if(b.hasOwnProperty("dn")){b[d].dn}else{b[d].fh}c.torrents[b[d].fh]={dn:b[d].dn,href:b[d].href}}}return c}function cleanName(a){a=decodeURIComponent(a);var b=a.match(/[A-Za-z][.]/g);if(Array.isArray(b))for(var c=0;c<b.length;c++){var d=b[c].split(".")[0]+" ";a=a.replace(b[c],d)}return a=a.replace(/  /g," & "),a=a.replace(/[_]/g," "),a=a.replace(/\.(?![0-9])/g," "),a=a.replace(/[.](?=[A-Za-z])/g," "),a=a.replace(/[+]/g," "),a=a.replace(/  /g," ")}function updatePopup(a){document.getElementById("title").innerHTML=a.title;var b=document.getElementById("list");if(a.links.hasOwnProperty("magnets")||a.links.hasOwnProperty("torrents")){var c=document.createElement("ol");b.appendChild(c);for(var d in a.links.magnets){var e=document.createElement("li"),f='<a href="'+a.links.magnets[d].href+'">[M]</a> ';f+=a.links.magnets[d].dn,e.innerHTML=f,c.appendChild(e)}for(var d in a.links.torrents){var e=document.createElement("li"),f='<a href="'+a.links.torrents[d].href+'">[T]</a> ';f+=a.links.torrents[d].dn,e.innerHTML=f,c.appendChild(e)}}else{if(isEmpty(a.links))return void(b.innerHTML="<p><i>No magnets or torrents found on this page.</i>");var c=document.createElement("ol");b.appendChild(c);for(var d in a.links){var e=document.createElement("li"),f='<a href="'+a.links[d].mhref+'">[M]</a>';f+='<a href="'+a.links[d].thref+'">[T]</a> ',f+=a.links[d].dn,e.innerHTML=f,c.appendChild(e)}}}function isEmpty(a){for(var b in a)return!a.hasOwnProperty(b);return!0}function processLinks(a,b){for(var c=[],d=[],e={title:a,links:{}},f=0;f<b.length;f++)0==b[f].search(/magnet:/i)?c.push(parseMagnet(b[f])):d.push(parseTorrent(b[f]));e.links=combineMT(c,d),updatePopup(e)}function getRandHex(a){for(var b=[0,1,2,3,4,5,6,7,8,9,"A","B","C","D","E","F"],c="",d=0;d<a;d++)c+=b[Math.floor(16*Math.random())];return c}document.addEventListener("DOMContentLoaded",function(){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{msg:"getdommagnet"},function(a){processLinks(a.msg.title,a.msg.links);for(var b=document.getElementsByTagName("a"),c=0;c<b.length;c++)!function(){var a=b[c],d=a.href;a.onclick=function(){chrome.tabs.create({active:!1,url:d},function(a){setTimeout(function(){chrome.tabs.remove(a.id)},4e3)})}}()})})});